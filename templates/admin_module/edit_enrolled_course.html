<!DOCTYPE html>
<html>
    <h1>Edit Enrolled Course</h1>
    
    <form method="post">
    {% csrf_token %}
    <!--Calls the function in script upon loading-->
    <body onload="loading()">
        <div>
    <label for="course_batch">Course Batch</label>
    <input type="text"  id="course_batch" name="course_batch" placeholder="{{enrolled_course.course_batch}}" value="{{enrolled_course.course_batch}}"required readonly="readonly">
    <br><br>
    
    <label>Course Title</label>
    
    <select name="course_title" id="course_title" value={{sid}}>
        <option selected hidden >{{sid}}</option>
        {% for value in option_course_id %}
            <option value="{{value}}">{{value}}</option>
        {% endfor %}

    </select>


    <br><br>
    
    <label for="session_details">Session Details</label>
    <input type="text" id="session_details" name="session_details" placeholder="{{enrolled_course.session_details}}" value="{{enrolled_course.session_details}}" required>
    <br><br>

    <label for="start_date">Start Date</label>
    <input type="date" id="start_date" name="start_date" placeholder="{{enrolled_course.start_date | date:'Y-m-d'}}" value="{{enrolled_course.start_date | date:'Y-m-d'}}" onchange="updateDropdown()" required>
    <br><br>

    <label for="end_date">End Date</label>
    <input type="date" id="end_date" name="end_date" placeholder="{{enrolled_course.end_date | date:'Y-m-d'}}" value="{{enrolled_course.end_date | date:'Y-m-d'}}" onchange="updateDropdown()" required>
    <br><br>


    
    <label for="start_time">Start Time</label>
    <input type="time" id="start_time" name="start_time" placeholder="{{enrolled_course.start_time}}" value="{{enrolled_course.start_time}}" onchange="updateDropdown()" required>

    <br><br>
    <label for="end_time">End Time</label>
    <input type="time" id="end_time" name="end_time" placeholder="{{enrolled_course.end_time}}" value="{{enrolled_course.end_time}}" onchange="updateDropdown()" required>
    
    <br><br>
    

		<label for="frequency">Frequency:</label>
		<select id="frequency" name= "frequency" onchange="updateDropdown()" required>
            <option selected hidden >{{sf}}</option>

			{% for value in lof%}
            <option value="{{value}}">{{value}}</option>
             {% endfor %}
		</select>
    <br><br>

    <label>Course Mode: </label>
    <select name="course_mode">
        <option selected hidden >{{scm}}</option>
        {% for value in course_mode%}
            <option value="{{value}}" >{{value}}</option>
        {% endfor %}

    </select>
    <br><br>
    
    <label>Instructor:</label>

    <select id="myDropdown" name="full_name"  required>
        <!-- <option selected hidden >{{iid}}</option> -->


    </select>
    <script>
        //this function fills the dropdown with instructor names
        function loading(){
            var professor = {{ full_name | safe}};
            updateDropdown(professor);              //calls the updateDropdown function
        }

        var dropdown = document.getElementById("myDropdown");
        
        function updateDropdown() {
            var myList = {{ schedules|safe}};       //accesses the "schedules" context
            var professor = {{ full_name | safe}};  //accesses the "full_name" context
            var startDate = new Date(document.getElementById("start_date").value);        //calendar start date
            var endDate = new Date(document.getElementById("end_date").value);            //calendar end date
            var startTime = document.getElementById("start_time").value;                //clock start time
            startTime = startTime.split(":").join("");  
            let sformNumberTime = parseInt(startTime);       //sformNumberTime==clock in int

        var endTime = document.getElementById("end_time").value;
        endTime = endTime.split(":").join("");
        let eformNumberTime = parseInt(endTime);       //eformNumberTime==clock in int

    
        for (var i = 0; i < myList.length; i++) {
            var person = myList[i];
            var fullname = person.fullname;
            var sd = person.session_date;
            var st = person.start_time.slice(0,5);
            st = st.split(":").join("");
            let schedule_s_Time = parseInt(st);          //schedule_s_Time
            var et = person.end_time.slice(0, 5);         //schedule_e_Time
            et = et.split(":").join("");
            let schedule_e_Time = parseInt(et);
            const ssdd = new Date(sd);    //start date in schedules (nth iteration))
            let elementToRemove = fullname;
            let index = professor.indexOf(elementToRemove);

            var freq = document.getElementById("frequency").value;

            if (freq !== "Weekly" ){
            //do this if frequency is daily or once
                if ((ssdd.getTime() >= startDate.getTime() && ssdd.getTime() <= endDate.getTime())  //sessiondate is within the calendar range
                ) {

                    if (schedule_s_Time >= sformNumberTime) {
                        if (schedule_s_Time < eformNumberTime){
                            if (index > -1) {
                                professor.splice(index, 1);
                            }
                        }
                    }
                            
                    if (schedule_s_Time < sformNumberTime &&  schedule_e_Time > eformNumberTime ) {
                        if (index > -1) {
                                professor.splice(index, 1);
                        }       
                    }
                        
                    if (schedule_s_Time < sformNumberTime &&  schedule_e_Time <= eformNumberTime && sformNumberTime < schedule_e_Time  ) {
                        if (index > -1) {
                                professor.splice(index, 1);
                        }       
                    }

                }

            }
            else if (freq == "Weekly") {//frequency is weekly
            var startDate = new Date(document.getElementById("start_date").value);        //calendar start date
            var endDate = new Date(document.getElementById("end_date").value);
                while (startDate <= endDate) {

                    if (startDate.getTime() === ssdd.getTime()){
                        if(startTime>=schedule_s_Time && startTime < schedule_e_Time && schedule_e_Time < endTime || // if context is 10am-2pm bawal sa time si 11am to 3pm
                        startTime>=schedule_s_Time && startTime < schedule_e_Time && endTime < schedule_e_Time && endTime > schedule_s_Time || // if context is 10am-2pm bawal sa time si 11am to 2pm
                        startTime <= schedule_s_Time && endTime > schedule_s_Time && endTime < schedule_e_Time && startTime < schedule_s_Time//// if context is 10am-2pm bawal sa time si 8am to 11am or si 10am to 11am
                        ){
                            // alert(elementToRemove);
                            if (index > -1) {
                                    professor.splice(index, 1)
                            }

                        }

                    }
                    startDate.setDate(startDate.getDate() + 7);
                }
            //closing ni else
            } 
        
        }
        call(professor); //passes the professor list as argument in the call function
    }

    function call(professor){
        //This function populates the dropdown and preselected the instructor being edited if available.
            dropdown.innerHTML = "";
            var defaultOption = document.createElement("option");
            defaultOption.value = "{{iid}}";  // Value for the default option
            defaultOption.text = "{{iid}}";

            for (var i = 0; i < professor.length; i++) {
            var option = document.createElement("option");
            option.text = professor[i];
            option.value = professor[i];
            dropdown.add(option);
        }

        if (professor.includes(defaultOption)) {
                defaultOption.selected = true;
            }

            defaultOption.hidden = true;
            dropdown.appendChild(defaultOption);




    }
    </script>
    </body>

    <br><br>


    
    <a href='course_enrollment/view_enrolled_course/'></a>
    <input class="button" type="submit" value="Submit" onclick="return validateDates() ">
    <div id="error-message" style="color: red;"></div>
    </form>


<script>

    function validateDates() {
    var errorMessage = document.getElementById('error-message');
    var startDate = new Date(document.getElementById("start_date").value);
    var endDate = new Date(document.getElementById("end_date").value);
    var startTime = document.getElementById("start_time").value;
    var endTime = document.getElementById("end_time").value;
    var frequency = document.getElementById("frequency").value; 

    if (startDate > endDate) {
        errorMessage.textContent = 'End date must be after start date.';
        return false;

        }

    
    else if (startDate < endDate) {
        if (frequency == "Once") {
        errorMessage.textContent = 'Startdate should be equal to endDate.';
        return false;
        }

        else{    
        errorMessage.textContent = ''; // Clear the error message
        return true;
        }

        
        }
    else { //equal ang dates
        
        if (startTime > endTime) {
            errorMessage.textContent = 'End time must be after start time.';
            return false;
        }    
        if (frequency !== "Once" ) {
            errorMessage.textContent = 'Frequency should be Once since start date = end date';
            return false;
        }
        errorMessage.textContent = ''; // Clear the error message
        return true;

    }
    }    
</script>


</html>